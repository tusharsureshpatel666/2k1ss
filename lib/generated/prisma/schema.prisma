// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum ShareMode {
  HOURS_BY_HOURS
  DAYS_BY_DAYS
  SPLIT_STORE
  DAY_OR_NIGHT
  Weekend
  Regular
}

model User {
  id    String  @id @default(uuid())
  name  String?
  email String? @unique
  image String?

  phone         String?
  phoneVerified Boolean @default(false)

  createdAt DateTime @default(now())

  stores       Store[]        @relation("OwerStores")
  likedStores  StoreLike[]
  notification Notification[]

  messages     Message[]
  buyer        Conversation[]
  UserPresence UserPresence[]
}

// ==========================
// CONVERSATION
// ==========================

// ==========================
// CONVERSATION â†” USER (JOIN TABLE)
// ==========================

// ==========================
// STORE
// ==========================
model Store {
  id String @id @default(uuid())

  ownerId String
  owner   User   @relation("OwerStores", fields: [ownerId], references: [id])

  title          String
  desc           String
  peopleDesc     String
  flatno         String
  streetAddress  String
  NearbyLandMark String
  areaLocality   String

  storeSize    String
  businessType String

  country String
  state   String
  city    String
  pin     String

  latitude  Float?
  longitude Float?

  bannerImageUrl String?
  images         StoreImage[]

  priceInr Int

  shareMode  ShareMode
  startTime  String?
  endTime    String?
  days       String[]
  sqft       Int?
  dayOrNight String?

  likes StoreLike[]

  store     Conversation[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
}

// ==========================
// STORE IMAGE
// ==========================
model StoreImage {
  id        String   @id @default(cuid())
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  url       String
  order     Int      @default(0)
  createdAt DateTime @default(now())

  @@index([storeId])
}

// ==========================
// STORE LIKE
// ==========================
model StoreLike {
  id      String @id @default(uuid())
  userId  String
  storeId String

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, storeId])
  @@index([storeId])
}

model Conversation {
  id String @id @default(uuid())

  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  buyerId String
  buyer   User   @relation(fields: [buyerId], references: [id])

  createdAt     DateTime @default(now())
  lastMessageAt DateTime @default(now())

  messages     Message[]
  notification Notification[]
  UserPresence UserPresence[]

  @@unique([storeId, buyerId])
  @@index([buyerId])
  @@index([storeId])
}

model Message {
  id String @id @default(uuid())

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  senderId String
  sender   User   @relation(fields: [senderId], references: [id], onDelete: Cascade)

  text String
  seen Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([senderId])
}

model Notification {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id])

  message String
  isRead  Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([conversationId])
}

model UserPresence {
  userId         String        @id
  user           User          @relation(fields: [userId], references: [id])
  conversationId String?
  conversation   Conversation? @relation(fields: [conversationId], references: [id])
  updatedAt      DateTime      @updatedAt
}
